PAYLOAD_DIR := payloads
OUTPUT_DIR := out

PAYLOADS := $(wildcard $(PAYLOAD_DIR)/*.s)
PAYLOADS_ELF := $(patsubst $(PAYLOAD_DIR)/%.s, $(OUTPUT_DIR)/%.elf, $(PAYLOADS))
PAYLOADS_BIN := $(patsubst $(PAYLOAD_DIR)/%.s, $(OUTPUT_DIR)/%.bin, $(PAYLOADS))
PAYLOADS_YAB :=\
	$(patsubst $(PAYLOAD_DIR)/%.s, $(OUTPUT_DIR)/%-95204.yab, $(PAYLOADS))\
	$(patsubst $(PAYLOAD_DIR)/%.s, $(OUTPUT_DIR)/%-95205.yab, $(PAYLOADS))\
	$(patsubst $(PAYLOAD_DIR)/%.s, $(OUTPUT_DIR)/%-95506.yab, $(PAYLOADS))

.PHONY: all
all: $(PAYLOADS_YAB)

$(OUTPUT_DIR)/%-95204.yab: $(OUTPUT_DIR)/%.bin maker
	./maker 95204 $< $(patsubst $(OUTPUT_DIR)/%.bin, $(PAYLOAD_DIR)/%.string, $<) > $@

$(OUTPUT_DIR)/%-95205.yab: $(OUTPUT_DIR)/%.bin maker
	./maker 95205 $< $(patsubst $(OUTPUT_DIR)/%.bin, $(PAYLOAD_DIR)/%.string, $<) > $@

$(OUTPUT_DIR)/%-95506.yab: $(OUTPUT_DIR)/%.bin maker
	./maker 95506 $< $(patsubst $(OUTPUT_DIR)/%.bin, $(PAYLOAD_DIR)/%.string, $<) > $@

maker: maker.c Makefile
	clang maker.c -o maker -O2
	./maker 95204 > $(OUTPUT_DIR)/patches-95204.yab
	./maker 95205 > $(OUTPUT_DIR)/patches-95205.yab
	./maker 95506 > $(OUTPUT_DIR)/patches-95506.yab

$(OUTPUT_DIR)/%.bin: $(OUTPUT_DIR)/%.elf
	ee-objcopy -O binary $< $@

$(OUTPUT_DIR)/%.elf: $(PAYLOAD_DIR)/%.s $(OUTPUT_DIR)
	ee-gcc $< -o $@ -nostartfiles -nostdlib

$(OUTPUT_DIR):
	mkdir $@

.PHONY: clean
clean:
	rm maker
	rm -rf $(OUTPUT_DIR)
